
# Nome do workflow, aparece na aba "Actions" do GitHub
name: CI

# Define os gatilhos que disparam esse workflow
on:
  push:  # Sempre que fizer push na branch main
    branches: [ main ]
  pull_request:  # Sempre que uma PR for aberta ou atualizada (para qualquer branch)

# Define o job (etapa principal do pipeline)
jobs:
  test-and-build:  # Nome do job
    runs-on: ubuntu-latest  # Vai rodar em uma VM Ubuntu fornecida pelo GitHub

    # Permissões para esse job:
    permissions:
      contents: read             # Permite ler o conteúdo do repositório (padrão)
      security-events: write     # Necessário para subir resultados de segurança (como SARIF)

    steps:  # Lista de etapas a executar dentro desse job
      - uses: actions/checkout@v4  # Clona o repositório no runner

      # Instala o Python 3.11 no ambiente do runner
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"  # Versão desejada do Python

      # Instala dependências da aplicação e ferramentas de análise (ruff e semgrep)
      - name: Install deps
        run: |
          python -m pip install --upgrade pip         # Atualiza o pip
          pip install -r requirements.txt             # Instala dependências do projeto
          pip install ruff semgrep                    # Instala ferramentas de lint e análise estática

      # Executa o Ruff (linting) para verificar problemas de estilo/código
      - name: Lint
        run: ruff check .

      # Faz build da imagem Docker
      - name: Docker build (no push)
        run: docker build -t auth-api:ci .  # Cria a imagem com a tag "auth-api:ci"

      # Executa o Semgrep com uma config automática, gerando um relatório SARIF
      - name: Semgrep scan (non-blocking + SARIF)
        run: |
          semgrep scan --config auto . \
                      --sarif --sarif-output=semgrep.sarif || true

      # Faz upload do relatório SARIF como artefato (sem usar Code Scanning)
      - name: Upload SARIF artifact
        if: always() && hashFiles('semgrep.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.sarif
